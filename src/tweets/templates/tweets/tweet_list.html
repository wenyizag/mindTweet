
{% extends 'base.html' %}

{% block title %}
	Tweet List | {{ block.super }}
{% endblock %}

{% block content %}
	<div class="row container">
		<div class="col-sm-3 col-xs-12">
			<h1>{{ request.user }}</h1>
		</div>
		<div class="col-sm-9 col-xs-12">
			{% if not request.GET.q %}
				<div class=''>
					{% include "tweets/form.html" with form=create_form action_url=create_url btn='Tweet' form_id='form_id'%}
				</div>
				<hr>
			{% endif %}
			<div id="list">
				
			</div>
			<button id="read-more" type="button" class="btn btn-primary mx-auto">Read More</button>
		</div>
	</div>
{% endblock %}

{% block script %}
<script>
function getParameterByName(name, url) {
    if (!url) {
      url = window.location.href;
    }
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}


$(document).ready(function(){
	var query = getParameterByName('q');
	var tweetList = [];

	fetchData();

	var charRemain = 140;
	var charTotal = 140;
	var nextPageURL;

	//Limite the size of tweet within 140 characters
	$('#form_id').append(`
			<span id="text-color">${charRemain}</span>
		`);
	$('input[type=text], textarea').keyup(function(){
		charRemain = charTotal - this.value.length;
		var textcolor = $('#text-color');
		textcolor.text(charRemain);

		if(charRemain > 0){
			textcolor.removeClass("text-danger text-secondary");
		}else if(charRemain == 0){
			textcolor.addClass("text-secondary");
			textcolor.removeClass("text-danger");
		}else{
			textcolor.addClass("text-danger");
			textcolor.RemoveClass("text-secondary");
		}
	});

	
	//submit new tweet
	$('#form_id').submit(function(e){
		e.preventDefault();

		var this_ = $(this);
		var formData = this_.serialize();
		if(charRemain >= 0){
			$.ajax({
				url: "/api/tweet/create/",
				data: formData,
				method: "POST",
				success: function(data){
					this_.find("input[type=text], textarea").val("");
					attachTweet(data, true);
					convertHashTag();	
					charRemain = 140;	
				},
				error: function(data){
				  console.log("error")
				  console.log(data.statusText);
				}
			})
		}else{

		}

	})

	//click read more button
	$('#read-more').click(function(e){
		e.preventDefault();
		console.log(nextPageURL);
		if(nextPageURL){		
			fetchData(nextPageURL);
		}
	})

	//fetch Data
	function fetchData(url){
		var fetchURL;
		if(!url){
			fetchURL = "/api/tweet/";
		}else{
			fetchURL = nextPageURL;
		}
		$.ajax({
			url: fetchURL,
			data: {
			  "q": query
			},
			method: "GET",
			success: function(data){
			  tweetList = data.results;
			  if(data.next){
			  	nextPageURL = data.next;
			  }else{
			  	$('#read-more').hide();
			  }
			  parseTweets();
			  convertHashTag();
			},
			error: function(data){
			  console.log("error");
			  console.log(data.statusText);
			}
		})
	}

	//append the fetched data to HTML
	function attachTweet(value, prepend, retweet){
		var content = value.content;
		var time = value.date_display;
		var user = value.user.username;
		var url = value.user.url;
		var myhtml;
		if(retweet && value.parent){
			var parent = value.parent;
			myhtml=`<div class="media">
							<div class="media-body">
								<span class="text-secondary">Retweet via ${user} on ${time}</span><br/>
								${parent.content}<br/>
								via <a href='${parent.user.url}'>${ parent.user.username }</a> | ${ parent.date_display } | <a href='tweet/${parent.id}'>View</a> | <a href='tweet/${parent.id}/retweet'>Retweet</a>
							</div>
						</div>
						<hr/>`;
		}else{
			myhtml = `<div class="media">
							<div class="media-body">
								${content}<br/>
								via <a href='${url}'>${ user }</a> | ${ time } | <a href='tweet/${value.id}/'>View</a> | <a href='tweet/${value.id}/retweet'>Retweet</a>
							</div>
						</div>
						<hr/>`;
		}
		if(prepend){
			$('#list').prepend(myhtml);
		}else {
			$('#list').append(myhtml);
		}
	}

	//Parse Tweet
	function parseTweets(){
		if(tweetList == 0){
			$("#list").text("No tweets currently found");
		}else{
			$.each(tweetList, function(key, value){
				if(value.parent){
					attachTweet(value, false, true);
				}else{
					attachTweet(value);
				}
				
			})
		}
	}

	//HashTag ans @user
	function convertHashTag(){
		$('.media-body').each(function(){
			var hashtagRegex = /(^|\s)#([\w\d-]+)/g;
			var usernameRegex = /(^|\s)@([\w\d-]+)/g;
			var currentHtml = $(this).html();
			var newText;
			newText = currentHtml.replace(hashtagRegex, "$1<a href='/tags/$2/'>#$2</a>");
			newText = newText.replace(usernameRegex, "$1<a href='/$2/'>@$2</a>");
			$(this).html(newText);
		})
	}
});
</script>

{% endblock %}


